// Generated by CoffeeScript 1.10.0
(function() {
  var factory;

  factory = function($http, $q) {
    var CynnyChunkUploader;
    return CynnyChunkUploader = (function() {
      CynnyChunkUploader.prototype._file = null;

      CynnyChunkUploader.prototype._signedToken = null;

      CynnyChunkUploader.prototype._uploadToken = null;

      CynnyChunkUploader.prototype._storageUrl = null;

      CynnyChunkUploader.prototype._bucket = null;

      CynnyChunkUploader.prototype._object = null;

      CynnyChunkUploader.prototype._chunkSize = null;

      CynnyChunkUploader.prototype._chunkIndex = null;

      CynnyChunkUploader.prototype._chunkArrayBuffer = null;

      function CynnyChunkUploader(params, index) {
        var required;
        if (params == null) {
          params = {};
        }
        required = ['signedToken', 'uploadToken', 'storageUrl', 'bucket', 'object', 'chunkSize', 'file', 'fileSize'];
        this._chunkIndex = index;
        this._processParams(params, required);
      }

      CynnyChunkUploader.prototype._processParams = function(params, required) {
        var i, len, p, pkeys, results;
        pkeys = Object.keys(params);
        results = [];
        for (i = 0, len = required.length; i < len; i++) {
          p = required[i];
          if (pkeys.indexOf(p) === -1) {
            throw new Error("params are missing required property '" + p + "'");
          }
          results.push(this["_" + p] = params[p]);
        }
        return results;
      };

      CynnyChunkUploader.prototype.upload = function() {
        return this._readFileChunk().then(this._uploadForm.bind(this)).then(this._destroy.bind(this));
      };

      CynnyChunkUploader.prototype._uploadForm = function() {
        return $q((function(_this) {
          return function(resolve, reject) {
            var fd, httpOptions, url;
            httpOptions = {
              transformRequest: angular.identity,
              headers: {
                'Content-Type': void 0,
                'x-cyn-signedtoken': _this._signedToken,
                'x-cyn-uploadtoken': _this._uploadToken
              }
            };
            fd = new FormData();
            fd.append('crc', _this._crcAdler32());
            fd.append('chunk', new Blob([_this._chunkArrayBuffer], {
              type: "application/octet-stream",
              size: _this._chunkArrayBuffer.length
            }));
            url = _this._storageUrl + "/b/" + _this._bucket + "/o/" + _this._object + "/cnk/" + _this._chunkIndex;
            $http.put(url, fd, httpOptions).then(function() {
              return resolve();
            })["catch"](function(err) {
              var ref;
              if ((200 <= (ref = Number(err.status)) && ref < 400)) {
                return resolve();
              } else {
                return reject(err);
              }
            });
          };
        })(this));
      };

      CynnyChunkUploader.prototype._readFileChunk = function() {
        return $q((function(_this) {
          return function(resolve, reject) {
            var end, reader, start;
            reader = new FileReader();
            reader.onerror = function(event) {
              return reject(event);
            };
            reader.onloadend = function(event) {
              if (event.target.readyState !== FileReader.DONE) {
                return false;
              }
              _this._chunkArrayBuffer = event.target.result;
              return resolve();
            };
            start = _this._chunkIndex * _this._chunkSize;
            end = Math.min(start + _this._chunkSize, _this._fileSize);
            reader.readAsArrayBuffer(_this._file.slice(start, end));
          };
        })(this));
      };

      CynnyChunkUploader.prototype._destroy = function() {
        this._file = null;
        this._signedToken = null;
        this._uploadToken = null;
        this._storageUrl = null;
        this._bucket = null;
        this._object = null;
        this._chunkSize = null;
        this._chunkIndex = null;
        this._chunkArrayBuffer = null;
        return true;
      };

      CynnyChunkUploader.prototype._crcAdler32 = function() {
        var a, b, data, i, len, n;
        a = 0;
        b = 0;
        data = new Uint8Array(this._chunkArrayBuffer);
        for (i = 0, len = data.length; i < len; i++) {
          n = data[i];
          a = (a + Number(n)) % 65521;
          b = (b + a) % 65521;
        }
        data = null;
        return ((b << 16) | a) >>> 0;
      };

      return CynnyChunkUploader;

    })();
  };

  angular.module('cynny').factory('CynnyChunkUploader', ['$http', '$q', factory]);

}).call(this);
